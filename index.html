<html>

<head>
	<meta content="text/html;charset=utf-8" http-equiv="Content-Type" />
</head>

<style>
	* {
		margin: 0;
		padding: 0;
	}

	/* to remove the top and left whitespace */

	html,
	body {
		width: 100%;
		height: 100%;
		background-color: white;
		overflow: hidden;
		/* Prevent scrollbars */
	}

	/* just to be sure these are full screen*/

	canvas {
		display: block;
		height: 100vh;
		width: 100%;
		/* Changed from 100vw to 100% */
	}

	#gui {
		position: absolute;
		top: 0;
		left: 0;
		background-color: rgba(0, 0, 0, 0.5);
		/* border: 1px solid black; */
		/* border-radius: 1px; */
		/* padding: 100px; */
		display: flex;
		text-align: center;
		flex-direction: column;
		justify-content: start;
		align-items: center;
		font-family: sans-serif;
		color: white;
		min-width: 250px;
		min-height: 500px;
	}

	/* button {
		background-color: white;
		color: black;
		border: 1px solid black;
		border-radius: 5px;
		padding: 5px;
		font-size: 16px;
	} */

	button:hover {
		background-color: lightgray;
		color: white;
	}

	button:active {
		background-color: black;
		color: white;
	}

	.checkbox-container {
		display: flex;
		flex-direction: row;
		align-items: center;
	}

	.checkbox-label {
		margin-right: 10px;
	}

	.checkbox {
		margin-right: 10px;
	}

	/* To remove the scrollbars */

	/* Mode overlay styles */
	.mode-border {
		position: fixed;
		top: 0;
		left: 0;
		right: 0;
		bottom: 0;
		pointer-events: none;
		z-index: 1000;
		transition: opacity 0.2s ease;
	}

	.slice-mode-border {
		border: 4px solid #ff0000;
		box-shadow: inset 0 0 20px rgba(255, 0, 0, 0.3);
	}

	.delete-mode-border {
		border: 4px solid #ffaa00;
		box-shadow: inset 0 0 20px rgba(255, 170, 0, 0.3);
	}

	.mode-instructions {
		position: fixed;
		top: 50px;
		left: 50%;
		transform: translateX(-50%);
		color: white;
		padding: 15px 25px;
		border-radius: 8px;
		font-family: sans-serif;
		font-size: 16px;
		font-weight: bold;
		text-align: center;
		box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
		z-index: 1001;
		animation: pulse 1.5s infinite;
	}

	.slice-instructions {
		background: rgba(255, 0, 0, 0.9);
	}

	.delete-instructions {
		background: rgba(255, 170, 0, 0.9);
	}

	.model-select-instructions {
		width: 100%;
		padding: 12px 16px;
		border-radius: 8px;
		border: 2px solid #444;
		background: linear-gradient(135deg, #2a2a2a, #1a1a1a);
		color: white;
		font-size: 14px;
		font-family: sans-serif;
		box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
		transition: all 0.3s ease;
		cursor: pointer;
	}

	.model-select-instructions:hover {
		border-color: #666;
		background: linear-gradient(135deg, #333, #222);
		box-shadow: 0 6px 20px rgba(0, 0, 0, 0.4);
	}

	.model-select-instructions:focus {
		outline: none;
		border-color: #ff6600;
		box-shadow: 0 0 0 3px rgba(255, 102, 0, 0.2);
	}

	.model-select-instructions option {
		background: #222;
		color: white;
		padding: 8px;
	}

	@keyframes pulse {

		0%,
		100% {
			opacity: 0.9;
		}

		50% {
			opacity: 1.0;
		}
	}

	.slice-line {
		position: fixed;
		background: #ff0000;
		height: 3px;
		z-index: 1002;
		pointer-events: none;
		box-shadow: 0 0 8px rgba(255, 0, 0, 0.6);
	}

	.loading-overlay {
		position: fixed;
		top: 0;
		left: 0;
		right: 0;
		bottom: 0;
		background: rgba(0, 0, 0, 0.8);
		display: flex;
		flex-direction: column;
		justify-content: center;
		align-items: center;
		z-index: 2000;
		color: white;
		font-family: sans-serif;
	}

	.loading-text {
		font-size: 18px;
		font-weight: bold;
		text-align: center;
		margin-top: 10px;
	}

	.loading-progress {
		width: 300px;
		height: 6px;
		background: rgba(255, 255, 255, 0.2);
		border-radius: 3px;
		margin-top: 15px;
		overflow: hidden;
	}

	.loading-progress-bar {
		height: 100%;
		background: linear-gradient(90deg, #ff0000, #ff6600);
		border-radius: 3px;
		animation: loadingProgress 2s ease-in-out infinite;
	}

	@keyframes loadingProgress {
		0% {
			width: 0%;
		}

		50% {
			width: 70%;
		}

		100% {
			width: 100%;
		}
	}

	/* Instructions overlay */
	.instructions-overlay {
		position: fixed;
		top: 0;
		left: 0;
		right: 0;
		bottom: 0;
		background: rgba(0, 0, 0, 0.9);
		display: flex;
		justify-content: center;
		align-items: center;
		z-index: 3000;
		color: white;
		font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
	}

	.instructions-content {
		background: linear-gradient(135deg, #1a1a1a, #2d2d2d);
		border: 2px solid #ff4444;
		border-radius: 15px;
		padding: 40px;
		max-width: 600px;
		box-shadow: 0 20px 40px rgba(0, 0, 0, 0.8);
		text-align: center;
		position: relative;
	}

	.instructions-title {
		font-size: 32px;
		font-weight: bold;
		margin-bottom: 30px;
		color: #ff4444;
		text-shadow: 0 0 10px rgba(255, 68, 68, 0.5);
	}

	.instructions-list {
		text-align: left;
		margin: 30px 0;
		font-size: 18px;
		line-height: 2.2;
	}

	.instruction-item {
		margin: 20px 0;
		padding: 15px 20px;
		background: rgba(255, 255, 255, 0.05);
		border-radius: 10px;
		border-left: 4px solid #ff4444;
		display: flex;
		align-items: center;
		font-weight: 500;
	}

	.instruction-key {
		font-weight: bold;
		color: #fff;
		font-family: 'Courier New', monospace;
		background: linear-gradient(135deg, #333, #555);
		padding: 8px 12px;
		border-radius: 8px;
		margin-right: 12px;
		border: 2px solid #666;
		box-shadow: 0 3px 6px rgba(0, 0, 0, 0.3), inset 0 1px 0 rgba(255, 255, 255, 0.1);
		font-size: 14px;
		letter-spacing: 1px;
		min-width: 60px;
		text-align: center;
		display: inline-block;
		position: relative;
		top: -1px;
	}

	.instruction-key:before {
		content: '';
		position: absolute;
		top: -2px;
		left: -2px;
		right: -2px;
		bottom: -2px;
		background: linear-gradient(135deg, #ff4444, #cc3333);
		border-radius: 10px;
		z-index: -1;
		opacity: 0.3;
	}

	.instructions-buttons {
		margin-top: 30px;
		display: flex;
		gap: 15px;
		justify-content: center;
	}

	.instruction-button {
		background: linear-gradient(135deg, #ff4444, #cc3333);
		color: white;
		border: none;
		padding: 12px 24px;
		border-radius: 8px;
		font-size: 16px;
		font-weight: bold;
		cursor: pointer;
		transition: all 0.3s ease;
		box-shadow: 0 4px 15px rgba(255, 68, 68, 0.3);
	}

	.instruction-button:hover:not(:disabled) {
		background: linear-gradient(135deg, #ff6666, #ff4444);
		transform: translateY(-2px);
		box-shadow: 0 6px 20px rgba(255, 68, 68, 0.4);
	}

	.instruction-button:disabled {
		background: linear-gradient(135deg, #666, #444);
		color: #999;
		cursor: not-allowed;
		opacity: 0.6;
	}

	.instruction-loading {
		margin-top: 20px;
		font-size: 14px;
		color: #ccc;
		display: flex;
		flex-direction: column;
		align-items: center;
		justify-content: center;
		gap: 10px;
	}

	.instruction-loading-bar {
		width: 200px;
		height: 4px;
		background: rgba(255, 255, 255, 0.2);
		border-radius: 2px;
		overflow: hidden;
		margin-top: 10px;
		margin-left: auto;
		margin-right: auto;
	}

	.instruction-loading-progress {
		height: 100%;
		background: linear-gradient(90deg, #ff4444, #ff6600);
		border-radius: 2px;
		width: 0%;
		transition: width 0.3s ease;
	}

	.instruction-button.secondary {
		background: linear-gradient(135deg, #666, #444);
		box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
	}

	.instruction-button.secondary:hover {
		background: linear-gradient(135deg, #888, #666);
		box-shadow: 0 6px 20px rgba(0, 0, 0, 0.4);
	}

	/* Help button */
	.help-button {
		position: fixed;
		top: 20px;
		right: 20px;
		background: linear-gradient(135deg, #ff4444, #cc3333);
		color: white;
		border: none;
		padding: 12px 16px;
		border-radius: 50%;
		font-size: 18px;
		font-weight: bold;
		cursor: pointer;
		z-index: 1500;
		box-shadow: 0 4px 15px rgba(255, 68, 68, 0.3);
		transition: all 0.3s ease;
		width: 50px;
		height: 50px;
		display: flex;
		align-items: center;
		justify-content: center;
	}

	.help-button:hover {
		background: linear-gradient(135deg, #ff6666, #ff4444);
		transform: scale(1.1);
		box-shadow: 0 6px 20px rgba(255, 68, 68, 0.5);
	}

	/* Updated GUI styling */
	#gui {
		background: linear-gradient(135deg, rgba(0, 0, 0, 0.8), rgba(20, 20, 20, 0.9));
		border: 1px solid #333;
		border-radius: 12px;
		backdrop-filter: blur(10px);
		box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);
		padding: 20px;
	}

	#gui h1 {
		color: #ff4444;
		text-shadow: 0 0 10px rgba(255, 68, 68, 0.5);
		margin-bottom: 20px;
		font-size: 24px;
	}

	.checkbox-container {
		background: rgba(255, 255, 255, 0.05);
		border-radius: 6px;
		padding: 8px 12px;
		margin: 8px 0;
		border: 1px solid rgba(255, 255, 255, 0.1);
		transition: all 0.2s ease;
	}

	.checkbox-container:hover {
		background: rgba(255, 255, 255, 0.08);
		border-color: rgba(255, 68, 68, 0.3);
	}

	input[type="checkbox"] {
		accent-color: #ff4444;
	}

	button {
		background: linear-gradient(135deg, #ff4444, #cc3333);
		color: white;
		border: none;
		padding: 10px 16px;
		border-radius: 6px;
		font-weight: bold;
		cursor: pointer;
		transition: all 0.3s ease;
		box-shadow: 0 2px 10px rgba(255, 68, 68, 0.2);
	}

	button:hover {
		background: linear-gradient(135deg, #ff6666, #ff4444);
		transform: translateY(-1px);
		box-shadow: 0 4px 15px rgba(255, 68, 68, 0.3);
	}

	select {
		background: rgba(0, 0, 0, 0.7);
		color: white;
		border: 1px solid #333;
		border-radius: 4px;
		padding: 4px 8px;
	}
</style>


<body>
	<script src="webgl-debug.js"></script>
	<script>
		Error.stackTraceLimit = Infinity;

		function test() {
			console.log("this is a test function!")
		}

		// Mode management functions
		let sliceStartPos = null;
		let sliceEndPos = null;
		let currentMode = null;

		function showMode(mode) {
			hideAllModes(); // Hide any existing mode first
			currentMode = mode;

			if (mode === 'slice') {
				document.getElementById('slice-mode-border').style.display = 'block';
				document.getElementById('slice-instructions').style.display = 'block';
			} else if (mode === 'delete') {
				document.getElementById('delete-mode-border').style.display = 'block';
				document.getElementById('delete-instructions').style.display = 'block';
			}
		}

		function hideAllModes() {
			document.getElementById('slice-mode-border').style.display = 'none';
			document.getElementById('slice-instructions').style.display = 'none';
			document.getElementById('delete-mode-border').style.display = 'none';
			document.getElementById('delete-instructions').style.display = 'none';
			hideSliceLine();
			currentMode = null;
		}

		// Legacy functions for backward compatibility
		function showSliceMode() {
			showMode('slice');
		}

		function hideSliceMode() {
			hideAllModes();
		}

		function showDeleteMode() {
			showMode('delete');
		}

		function hideDeleteMode() {
			hideAllModes();
		}

		function showSliceLine(startX, startY, endX, endY) {
			const sliceLine = document.getElementById('slice-line');

			// Calculate line position and rotation
			const dx = endX - startX;
			const dy = endY - startY;
			const length = Math.sqrt(dx * dx + dy * dy);
			const angle = Math.atan2(dy, dx) * 180 / Math.PI;

			// Position the line
			sliceLine.style.left = startX + 'px';
			sliceLine.style.top = startY + 'px';
			sliceLine.style.width = length + 'px';
			sliceLine.style.transform = `rotate(${angle}deg)`;
			sliceLine.style.transformOrigin = '0 50%';
			sliceLine.style.display = 'block';
		}

		function hideSliceLine() {
			document.getElementById('slice-line').style.display = 'none';
		}

		function showLoadingOverlay(message = 'Processing slice...') {
			document.getElementById('loading-text').textContent = message;
			document.getElementById('loading-overlay').style.display = 'flex';
		}

		function hideLoadingOverlay() {
			document.getElementById('loading-overlay').style.display = 'none';
		}

		function updateLoadingMessage(message) {
			document.getElementById('loading-text').textContent = message;
		}

		// Instructions overlay management
		function showInstructions() {
			document.getElementById('instructions-overlay').style.display = 'flex';
		}

		function hideInstructions() {
			document.getElementById('instructions-overlay').style.display = 'none';
		}

		function setInstructionsLoading(isLoading, message = 'Loading scene...') {
			const loadingElement = document.getElementById('instruction-loading');
			const startButton = document.getElementById('start-exploring');
			const progressBar = document.querySelector('.instruction-loading-progress');

			if (isLoading) {
				loadingElement.style.display = 'block';
				loadingElement.querySelector('span').textContent = message;
				startButton.disabled = true;
				startButton.textContent = 'Loading...';

				// Extract percentage from message if present
				const percentMatch = message.match(/(\d+)%/);
				if (percentMatch) {
					const percentage = parseInt(percentMatch[1]);
					if (progressBar) {
						progressBar.style.width = percentage + '%';
					}
				} else {
					// No percentage, start at 0%
					if (progressBar) {
						progressBar.style.width = '0%';
					}
				}
			} else {
				loadingElement.style.display = 'none';
				startButton.disabled = false;
				startButton.textContent = 'Start Exploring!';
				if (progressBar) {
					progressBar.style.width = '0%';
				}
			}
		}

		function setModelLoading(isLoading, message = 'Loading model...') {
			if (document.getElementById('instructions-overlay').style.display === 'flex') {
				setInstructionsLoading(isLoading, message);
			}
		}

		// Initialize instructions on page load
		document.addEventListener('DOMContentLoaded', function () {
			// Show instructions on every page load/refresh
			showInstructions();
			// Start in loading state
			setInstructionsLoading(true, 'Loading model...');

			// Handle instruction buttons
			document.getElementById('start-exploring').addEventListener('click', function () {
				hideInstructions();
			});

			// Handle help button
			document.getElementById('help-button').addEventListener('click', function () {
				showInstructions();
			});

			// Close instructions with Escape key
			document.addEventListener('keydown', function (e) {
				if (e.key === 'Escape' && document.getElementById('instructions-overlay').style.display === 'flex') {
					hideInstructions();
				}
			});
		});

	</script>
	<canvas id="canvas"></canvas>

	<!-- Help button -->
	<button id="help-button" class="help-button">?</button>

	<!-- Instructions overlay -->
	<div id="instructions-overlay" class="instructions-overlay">
		<div class="instructions-content">
			<h2 class="instructions-title">🍎 Fruit Ninja GSplat 🗡️</h2>
			<div class="instructions-list">
				<div class="instruction-item">
					<span class="instruction-key">WASD</span>Move around the scene
				</div>
				<div class="instruction-item">
					<span class="instruction-key">Mouse Drag</span>Look around / rotate camera
				</div>
				<div class="instruction-item">
					<span class="instruction-key">Alt + Click</span>Take a bite / delete splats
				</div>
				<div class="instruction-item">
					<span class="instruction-key">Space</span>Move up
				</div>
				<div class="instruction-item">
					<span class="instruction-key">Shift</span>Move down
				</div>
				<div class="instruction-item">
					<span class="instruction-key">P + Drag</span>Hold P and drag to slice objects
				</div>
				<div class="instruction-item">
					<span class="instruction-key">O</span>Toggle octree visualization
				</div>
			</div>
			<p style="margin: 20px 0; color: #ccc; font-style: italic;">
				Explore the 3D scene and slice through objects with realistic physics!
			</p>
			<div id="instruction-loading" class="instruction-loading" style="display: none;">
				<span>Loading scene...</span>
				<div class="instruction-loading-bar">
					<div class="instruction-loading-progress"></div>
				</div>
			</div>
			<div style="margin: 20px 0;">
				<label for="instruction-model-switcher"
					style="color: #ccc; display: block; margin-bottom: 10px; font-weight: 500;">Switch
					Model:</label>
				<select id="instruction-model-switcher"
					onchange="switchModelFromInstructions(this.value)"
					class="model-select-instructions">
					<option value="">Select a model...</option>
				</select>
			</div>
			<div class="instructions-buttons">
				<button id="start-exploring" class="instruction-button">Start Exploring!</button>
			</div>
		</div>
	</div>

	<!-- Mode UI elements -->
	<div id="slice-mode-border" class="mode-border slice-mode-border" style="display: none;"></div>
	<div id="slice-instructions" class="mode-instructions slice-instructions" style="display: none;">
		Click and drag to define a slice line
	</div>
	<div id="slice-line" class="slice-line" style="display: none;"></div>

	<div id="delete-mode-border" class="mode-border delete-mode-border" style="display: none;"></div>
	<div id="delete-instructions" class="mode-instructions delete-instructions" style="display: none;">
		Click to delete splats
	</div>

	<!-- Loading overlay -->
	<div id="loading-overlay" class="loading-overlay" style="display: none;">
		<div id="loading-text" class="loading-text">Processing slice...</div>
		<div class="loading-progress">
			<div class="loading-progress-bar"></div>
		</div>
	</div>

	<div id="gui">
		<h1>Fruit Ninja GSplat</h1>
		<!-- <button onclick="">Testing</button> -->
		<div class="checkbox-container">
			<label for="checkbox" class="checkbox-label">Show Octtree</label>
			<input type="checkbox" class="checkbox" id="show-octtree-checkbox">
		</div>
		<div class="checkbox-container" style="display: none;">
			<label for="checkbox" class="checkbox-label">Only Show Octree at Click </label>
			<input type="checkbox" class="checkbox" id="only-show-clicks-checkbox">
		</div>
		<div class="checkbox-container" style="display: none;">
			<label for="checkbox" class="checkbox-label">Use OctTree for Editing </label>
			<input type="checkbox" class="checkbox" id="use-octtree-for-editing-checkbox" checked>
		</div>
		<div class="checkbox-container">
			<label for="checkbox" class="checkbox-label">View Individual Splats </label>
			<input type="checkbox" class="checkbox" id="view-individual-splats-checkbox">
		</div>
		<div class="checkbox-container">
			<label for="checkbox" class="checkbox-label">Do Sorting </label>
			<input type="checkbox" class="checkbox" id="do-sorting-checkbox" checked>
		</div>
		<div class="checkbox-container">
			<label for="checkbox" class="checkbox-label">Do Blending </label>
			<input type="checkbox" class="checkbox" id="do-blending-checkbox" checked>
		</div>
		<div class="checkbox-container" style="display: none;">
			<label for="checkbox" class="checkbox-label">Move Down </label>
			<input type="checkbox" class="checkbox" id="move-down-checkbox">
		</div>
		<div class="checkbox-container">
			<label for="checkbox" class="checkbox-label">Detect Collisions With Gizmo</label>
			<input type="checkbox" class="checkbox" id="restrict-gizmo-movement-checkbox">
		</div>
		<div style="margin: 10px 0px; display: none;">
			<button id="calculate-shadows-btn">Calculate Shadows</button>
		</div>
		<div style="margin: 10px 0px;">
			<button id="recalculate-octtree-btn">Recalculate Octtree</button>

		</div>
		<div style="margin: 10px 0px; display: none;">
			<button id="add-shahan-btn">Add Shahan</button>
		</div>
		<div style="margin: 10px 0px; display:none;">
			<button id="add-teapot-btn">Add Teapot</button>
		</div>
		<div style="margin: 10px 0px; display: none;">
			<button id="split-object-btn">Split Object</button>
			<select id="split-direction" style="width: 150px; margin-left: 5px;">
				<option value="vertical">Vertical Split (X-axis)</option>
				<option value="horizontal">Horizontal Split (Y-axis)</option>
				<option value="depth">Depth Split (Z-axis)</option>
			</select>
		</div>
		<div style="margin: 10px 0px;">
			<span id="collision-detected-span" style="color: rgb(255, 50, 50);"></span>
		</div>
		<div style="margin: 10px 0px;">
			<label for="model-switcher" style="color: white;">Switch Model:</label>
			<select id="model-switcher" onchange="switchModel(this.value)"></select>
		</div>
	</div>
	</div>
	<script>
		const USE_LOCAL = false; // Set this to true to use local URLs, false for remote S3 URLs
		const BASE_LOCAL_URL = "http://127.0.0.1:5503/";
		const BASE_REMOTE_URL = "https://zimpmodels.s3.us-east-2.amazonaws.com/";

		function getWebGLContext() {
			ctx = WebGLDebugUtils.makeDebugContext(canvas.getContext("webgl2"));
			return ctx;
		}
		function setCollisionDetected() {
			document.getElementById("collision-detected-span").innerText = "Collision Detected";
			setTimeout(() => {
				document.getElementById("collision-detected-span").innerText = "";
			}, 1000);
		}
		function switchModel(url) {
			const baseUrl = USE_LOCAL ? BASE_LOCAL_URL : "./";

			// Find the model's camera configuration
			const MODEL_LIST = getModelList();
			const selectedModel = MODEL_LIST.find(model => model.file === url);
			let cameraParam = "";

			if (selectedModel && selectedModel.camera) {
				cameraParam = `&camera=${encodeURIComponent(JSON.stringify(selectedModel.camera))}`;
			}

			window.location.href = baseUrl + "?url=" + url + cameraParam;
		}

		// Global variable to track AbortController for cancelling requests
		let currentLoadController = null;

		function switchModelFromInstructions(url) {
			if (!url) return; // Don't switch if no model selected

			// Immediately show switching state
			setInstructionsLoading(true, 'Switching model...');

			// Try to stop everything immediately
			try {
				// Cancel any ongoing loading
				if (currentLoadController) {
					currentLoadController.abort();
					currentLoadController = null;
				}

				// Cancel workers and timers
				if (worker) {
					worker.terminate();
					worker = null;
				}

				// Clear all timeouts aggressively
				for (let i = 0; i < 10000; i++) {
					clearTimeout(i);
					clearInterval(i);
				}

				// Try to stop any ongoing fetch requests (if any globals exist)
				if (window.stop) {
					window.stop();
				}

			} catch (e) {
				console.log("Error during cancellation:", e);
			}

			// Force immediate redirect
			switchModel(url);
		}


		// FILES=(
		//     "apple_rotate.ply"
		//     "bread.ply"
		//     "cake.ply"
		//     "orange.ply"
		//     "watermelon.ply"
		// )
		// Define model paths that are the same for both local and remote
		const MODEL_PATHS = [
			// { display: "Cake 100%", file: "/ninja/cake_rotate.rkyv", camera: { pos: [-6.679095, 0.14607938, -0.32618168], rot: [-0.13400005, -1.5560011] } },
			// { display: "Cake 90%", file: "/ninja/cake_rotate_9.rkyv", camera: { pos: [-6.679095, 0.14607938, -0.32618168], rot: [-0.13400005, -1.5560011] } },
			// { display: "Cake 100%", file: "/ninja/cake_rotate.rkyv", camera: { pos: [-6.679095, 0.14607938, -0.32618168], rot: [-0.13400005, -1.5560011] } },
			// { display: "Apple 100%", file: "/ninja/apple_rotate.rkyv", camera: { pos: [-6.679095, 0.14607938, -0.32618168], rot: [-0.13400005, -1.5560011] } },
			// { display: "Bread 100%", file: "/ninja/bread.rkyv", camera: { pos: [-6.679095, 0.14607938, -0.32618168], rot: [-0.13400005, -1.5560011] } },
			// { display: "Orange 100%", file: "/ninja/orange.rkyv", camera: { pos: [-6.679095, 0.14607938, -0.32618168], rot: [-0.13400005, -1.5560011] } },
			// { display: "Watermelon 100%", file: "/ninja/watermelon.rkyv", camera: { pos: [-6.679095, 0.14607938, -0.32618168], rot: [-0.13400005, -1.5560011] } },

			{ display: "Cake 80%", file: "/ninja/cake_rotate_8.rkyv", camera: { pos: [-6.679095, 1.14607938, -0.32618168], rot: [-0.13400005, -1.5560011] } },
			// { display: "Orange 80%", file: "/ninja/orange_8.rkyv", camera: { pos: [-6.679095, 0.14607938, -0.32618168], rot: [-0.13400005, -1.5560011] } },
			// { display: "Apple 80%", file: "/ninja/apple_rotate_8.rkyv", camera: { pos: [-6.679095, 0.14607938, -0.32618168], rot: [-0.13400005, -1.5560011] } },
			// { display: "Watermelon 80%", file: "/ninja/watermelon_8.rkyv", camera: { pos: [-6.679095, 0.14607938, -0.32618168], rot: [-0.13400005, -1.5560011] } },
			// { display: "Bread 80%", file: "/ninja/bread_8.rkyv", camera: { pos: [-6.679095, 0.14607938, -0.32618168], rot: [-0.13400005, -1.5560011] } },
			{ display: "Orange 50%", file: "/ninja/orange_5.rkyv", camera: { pos: [-6.679095, 0.14607938, -0.32618168], rot: [-0.13400005, -1.5560011] } },
			{ display: "Apple 50%", file: "/ninja/apple_rotate_5.rkyv", camera: { pos: [-6.679095, 0.14607938, -0.32618168], rot: [-0.13400005, -1.5560011] } },
			{ display: "Cake 50%", file: "/ninja/cake_rotate_5.rkyv", camera: { pos: [-5.679095, 2.14607938, 0.32618168], rot: [-0.28400005, -1.5560011] } },
			// { display: "Watermelon 50%", file: "/ninja/watermelon_5.rkyv", camera: { pos: [-6.679095, 0.14607938, -0.32618168], rot: [-0.13400005, -1.5560011] } },
			{ display: "Bread 50%", file: "/ninja/bread_5.rkyv", camera: { pos: [-6.679095, 0.14607938, -0.32618168], rot: [-0.13400005, -1.5560011] } },

			{ display: "Orange 30%", file: "/ninja/orange_3.rkyv", camera: { pos: [-6.679095, 0.14607938, -0.32618168], rot: [-0.13400005, -1.5560011] } },
			{ display: "Apple 30%", file: "/ninja/apple_rotate_3.rkyv", camera: { pos: [-6.679095, 0.14607938, -0.32618168], rot: [-0.13400005, -1.5560011] } },
			{ display: "Cake 30%", file: "/ninja/cake_rotate_3.rkyv", camera: { pos: [-6.679095, 0.14607938, -0.32618168], rot: [-0.13400005, -1.5560011] } },
			// { display: "Watermelon 30%", file: "/ninja/watermelon_3.rkyv", camera: { pos: [-6.679095, 0.14607938, -0.32618168], rot: [-0.13400005, -1.5560011] } },
			{ display: "Bread 30%", file: "/ninja/bread_3.rkyv", camera: { pos: [-6.679095, 0.14607938, -0.32618168], rot: [-0.13400005, -1.5560011] } },
			{ display: "Watermelon 10%", file: "/ninja/watermelon_1.rkyv", camera: { pos: [-6.679095, 0.14607938, -0.32618168], rot: [-0.13400005, -1.5560011] } },


			// { display: "Orange Fuller", file: "/ninja/orange_fuller.rkyv", camera: { pos: [-6.679095, 0.14607938, -0.32618168], rot: [-0.13400005, -1.5560011] } },
			// { display: "Orange Extra Full", file: "/ninja/orange_extra_full.rkyv", camera: { pos: [-6.679095, 0.14607938, -0.32618168], rot: [-0.13400005, -1.5560011] } },
			// // { display: "Apple ", file: "/ninja/apple_extra_full.rkyv", camera: { pos: [-6.679095, 0.14607938, -0.32618168], rot: [-0.13400005, -1.5560011] } },
			// { display: "Apple 50%", file: "/ninja/apple_rotate_5.rkyv", camera: { pos: [-6.679095, 0.14607938, -0.32618168], rot: [-0.13400005, -1.5560011] } },
			// { display: "Apple 80%", file: "/ninja/apple_rotate_extra_full.rkyv", camera: { pos: [-6.679095, 0.14607938, -0.32618168], rot: [-0.13400005, -1.5560011] } },
			// { display: "Bread Extra Full", file: "/ninja/bread_extra_full.rkyv", camera: { pos: [-6.679095, 0.14607938, -0.32618168], rot: [-0.13400005, -1.5560011] } },
			// { display: "Cake Extra Full", file: "/ninja/cake_extra_full.rkyv", camera: { pos: [-6.679095, 0.14607938, -0.32618168], rot: [-0.13400005, -1.5560011] } },
			// { display: "Watermelon Extra Full", file: "/ninja/watermelon_extra_full.rkyv", camera: { pos: [-6.679095, 0.14607938, -0.32618168], rot: [-0.13400005, -1.5560011] } },
			// camera: { pos: [-0.121334, 1.292581, 2.461792], rot: [-0.019000, 3.261999] }
			{ display: "House", file: "/soc_01_polycam.rkyv", camera: { pos: [-0.121334, 1.292581, 2.461792], rot: [-0.019000, 3.261999] } },

			{ display: "E7 Outdoor", file: "/E7_01_id01-30000.rkyv", camera: { pos: [-6.679095, 0.14607938, -0.32618168], rot: [-0.13400005, -1.5560011] } },
			{ display: "E7 Indoor", file: "/Shahan_03_id01-30000.rkyv", camera: { pos: [-6.679095, 0.14607938, -0.32618168], rot: [-0.13400005, -1.5560011] } },
			{ display: "Grass", file: "/socratica_01_edited.rkyv", camera: { pos: [-6.679095, 0.14607938, -0.32618168], rot: [-0.13400005, -1.5560011] } },


			{ display: "Sci", file: "/sci_01_edited.rkyv", camera: { pos: [-1.103975, 0.375719, -0.574351], rot: [-0.23, -0.987] } },

			{ display: "Shahan", file: "/Shahan_03_id01-30000.cleaned.rkyv", camera: { pos: [-6.679095, 0.14607938, -0.32618168], rot: [-0.13400005, -1.5560011] } },


			// camera: { pos: [0.538205, 0.053799, -0.950825], rot: [-0.115000, 0.740999] }
			{ display: "The Rec", file: "/rec_cleaned_2.rkyv", camera: { pos: [0.538205, 0.053799, -0.950825], rot: [-0.115000, 0.740999] } },

			{ display: "Neo Dinner", file: "/neo_splat.rkyv", camera: { pos: [-1.007118, 0.862803, 2.109383], rot: [-0.107000, -2.353001] } },

			// camera: { pos: [-0.082226, -0.036270, 5.421075], rot: [-0.136000, -3.400000] }
			{ display: "Afterparty", file: "/afterparty.rkyv", camera: { pos: [-0.082226, -0.036270, 5.421075], rot: [-0.136000, -3.400000] } },

		];
		// camera: { pos: [-1.007118, 0.862803, 2.109383], rot: [-0.107000, -2.353001] }

		// Function to get the full model list with appropriate URLs
		function getModelList() {
			return MODEL_PATHS.map(model => ({
				display: model.display,
				file: USE_LOCAL ?
					BASE_LOCAL_URL + "splats" + model.file :
					BASE_REMOTE_URL + "splats" + model.file,
				camera: model.camera
			}));
		}

		// Function to populate the dropdowns
		function populateModelSelector() {
			const modelSelect = document.getElementById('model-switcher');
			const instructionModelSelect = document.getElementById('instruction-model-switcher');
			const MODEL_LIST = getModelList();

			MODEL_LIST.forEach(model => {
				// Populate main dropdown
				const option = document.createElement('option');
				option.value = model.file;
				option.textContent = model.display;
				modelSelect.appendChild(option);

				// Populate instruction dropdown
				const instructionOption = document.createElement('option');
				instructionOption.value = model.file;
				instructionOption.textContent = model.display;
				instructionModelSelect.appendChild(instructionOption);
			});
		}

		// Modified window.onload to include populating the dropdown
		window.addEventListener('load', function () {
			populateModelSelector();

			const urlParams = new URLSearchParams(window.location.search);
			const currentUrl = urlParams.get('url');
			const modelSelect = document.getElementById('model-switcher');
			const instructionModelSelect = document.getElementById('instruction-model-switcher');
			// const defaultModel = "Shahan_03_id01-30000.cleaned.rkyv";
			const defaultModel = "cake_rotate_5.rkyv";
			const defaultFullPath = USE_LOCAL ?
				BASE_LOCAL_URL + "splats" + defaultModel :
				BASE_REMOTE_URL + "splats" + defaultModel;

			if (currentUrl) {
				// Try to select the matching option in both dropdowns
				modelSelect.value = currentUrl;
				instructionModelSelect.value = currentUrl;
			} else {
				// If no URL parameter, load the default model
				const shahanModel = MODEL_PATHS.find(model => model.display === "Cake 50%");
				if (shahanModel) {
					const fullPath = USE_LOCAL ?
						BASE_LOCAL_URL + "splats" + shahanModel.file :
						BASE_REMOTE_URL + "splats" + shahanModel.file;

					modelSelect.value = fullPath;
					instructionModelSelect.value = fullPath;

					// Redirect to include the URL parameter
					const baseUrl = USE_LOCAL ? BASE_LOCAL_URL : "./";
					const cameraParam = shahanModel.camera ?
						`&camera=${encodeURIComponent(JSON.stringify(shahanModel.camera))}` : "";

					// Only redirect if we're not already on the right URL
					if (!currentUrl) {
						window.location.href = baseUrl + "?url=" + fullPath + cameraParam;
					}
				}
			}
		});
	</script>
	<script type="module">

		const look_speed = 0.05;
		const move_speed = 1;

		function resizeCanvasToDisplaySize(canvas) {
			// https://webgl2fundamentals.org/webgl/lessons/webgl-resizing-the-canvas.html
			// Lookup the size the browser is displaying the canvas in CSS pixels.
			const displayWidth = canvas.clientWidth;
			const displayHeight = canvas.clientHeight;

			// Check if the canvas is not the same size.
			const needResize = canvas.width !== displayWidth ||
				canvas.height !== displayHeight;

			if (needResize) {
				// Make the canvas the same size
				canvas.width = displayWidth;
				canvas.height = displayHeight;
			}
			return needResize;
		}
		let canvas = document.getElementById("canvas");
		resizeCanvasToDisplaySize(canvas);

		// Hide the initialization button - user doesn't want to see WebAssembly initialization
		const initButton = document.createElement('button');
		initButton.style.display = 'none'; // Hide completely
		document.body.appendChild(initButton);

		// Hide the WebAssembly status messages - user doesn't want to see them
		const statusMessage = document.createElement('div');
		statusMessage.style.display = 'none'; // Hide completely
		document.body.appendChild(statusMessage);

		// Use ES module import syntax to import functionality from the module
		// that we have compiled.
		//
		// Note that the `default` import is an initialization function which
		// will "boot" the module and make it ready to use. Currently browsers
		// don't support natively imported WebAssembly as an ES module, but
		// eventually the manual initialization won't be required!
		import init from './pkg/gs_rust.js';

		// Function to update status message
		function updateStatus(message, isError = false) {
			// Hide WebAssembly initialization messages - user doesn't want to see them
			console.log("Status update:", message); // Still log to console for debugging

			// Only show model loading messages in the instructions overlay
			if (document.getElementById('instructions-overlay').style.display === 'flex') {
				if (isError) {
					// Only show actual errors, not warnings about browser features
					if (!message.includes('Multithreading not supported')) {
						setInstructionsLoading(true, 'Error loading scene');
					}
				} else if (message.includes('ready') || message.includes('Ready') || message.includes('Successfully') || message.includes('success')) {
					// WebAssembly finished - but don't hide loading until model is done
					console.log("WebAssembly ready, but waiting for model completion");
				}
				// Don't show WebAssembly initialization messages in UI
			}
		}

		// Worker reference
		let worker = null;

		// Function to initialize WebAssembly
		async function initializeWasm() {
			try {
				updateStatus("Starting WebAssembly initialization...");

				// Disable the button during initialization
				initButton.disabled = true;
				initButton.textContent = 'Initializing...';

				// Initialize the WebAssembly module on the main thread
				// This is needed to load the module initially
				updateStatus("Loading WebAssembly module on main thread...");
				await init();
				updateStatus("WebAssembly module loaded successfully on main thread");

				// Check for multithreading support
				const hasSharedArrayBuffer = typeof SharedArrayBuffer !== 'undefined';
				const hasAtomics = typeof Atomics !== 'undefined';
				const multithreadingSupported = hasSharedArrayBuffer && hasAtomics;

				if (!multithreadingSupported) {
					updateStatus("Note: Multithreading not supported in this browser (SharedArrayBuffer or Atomics missing)", false);
					console.warn("Multithreading not supported: SharedArrayBuffer or Atomics not available");

					// Create a worker for single-threaded mode anyway
					// This avoids Atomics.wait on main thread issues
					createAndInitializeWorker(1);
				} else {
					// Calculate number of threads based on hardware concurrency
					// Limiting to 2 threads for stability during testing
					const numThreads = Math.min(navigator.hardwareConcurrency || 4, 2);
					updateStatus("Detected " + navigator.hardwareConcurrency + " CPU cores, using " + numThreads + " threads");

					// Create and initialize the worker with the thread pool
					createAndInitializeWorker(numThreads);
				}
			} catch (error) {
				console.error("Error during initialization:", error);
				// Display error to user
				initButton.textContent = 'Initialization Failed - Try Again';
				initButton.disabled = false;
				initButton.style.backgroundColor = 'red';

				updateStatus("Error: " + error.message, true);
			}
		}

		// Function to create and initialize the worker
		function createAndInitializeWorker(numThreads) {
			try {
				updateStatus("Creating worker for thread pool initialization with " + numThreads + " threads...");

				// Create the worker
				const workerUrl = USE_LOCAL ? (BASE_LOCAL_URL + '/worker.js') : './worker.js';
				worker = new Worker(new URL(workerUrl, import.meta.url), { type: 'module' });

				// Set up message handler for the worker
				worker.onmessage = function (e) {
					const { status, message, success, threads, stack } = e.data;

					switch (status) {
						case 'worker_loaded':
							updateStatus("Worker loaded successfully");
							// Initialize the worker
							worker.postMessage({ type: 'init', numThreads });
							break;

						case 'initializing_wasm':
							updateStatus("Worker: Initializing WebAssembly module...");
							break;

						case 'wasm_initialized':
							updateStatus("Worker: WebAssembly module initialized successfully");
							break;

						case 'initializing_thread_pool':
							updateStatus("Worker: Initializing thread pool with " + threads + " threads...");
							break;

						case 'thread_pool_initialized':
							updateStatus("Worker: Thread pool initialized successfully!");
							initButton.textContent = 'Initialized Successfully';
							initButton.style.backgroundColor = 'green';

							// Tell the worker to execute any initial commands
							worker.postMessage({ type: 'execute' });
							break;

						case 'ready_for_commands':
							updateStatus("Worker: Ready to execute commands");
							break;

						case 'error':
							console.error("Worker error:", message, stack);
							updateStatus("Worker error: " + message, true);
							initButton.textContent = 'Initialization Failed - Try Again';
							initButton.disabled = false;
							initButton.style.backgroundColor = 'red';
							break;

						default:
							console.log("Worker message:", e.data);
					}
				};

				// Handle worker errors
				worker.onerror = function (error) {
					console.error("Worker error:", error);
					updateStatus("Worker error: " + error.message, true);
					initButton.textContent = 'Initialization Failed - Try Again';
					initButton.disabled = false;
					initButton.style.backgroundColor = 'red';
				};
			} catch (error) {
				console.error("Error creating worker:", error);
				updateStatus("Error creating worker: " + error.message, true);
				initButton.textContent = 'Initialization Failed - Try Again';
				initButton.disabled = false;
				initButton.style.backgroundColor = 'red';
			}
		}

		// Add click event listener to the initialization button
		// initButton.addEventListener('click', initializeWasm);
		initializeWasm();

		// Don't automatically initialize - wait for user to click the button
		console.log("WebAssembly initialization deferred. Click the 'Initialize WebAssembly' button to start.");
	</script>
	<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@picocss/pico@2/css/pico.min.css">

	<!-- Add button to print current camera position -->
	<script>
		document.addEventListener('DOMContentLoaded', function () {
			const gui = document.getElementById('gui');

			// Create button for printing camera position
			const printCameraBtn = document.createElement('button');
			printCameraBtn.id = 'print-camera-btn';
			printCameraBtn.textContent = 'Print Camera Position';
			printCameraBtn.style.margin = '10px 0px';

			// Create div to display camera position
			const cameraPositionDiv = document.createElement('div');
			cameraPositionDiv.id = 'camera-position';
			cameraPositionDiv.style.margin = '10px 0px';
			cameraPositionDiv.style.color = 'white';
			cameraPositionDiv.style.fontSize = '10px';
			cameraPositionDiv.style.maxWidth = '250px';
			cameraPositionDiv.style.wordWrap = 'break-word';

			// Create copy to clipboard button
			const copyBtn = document.createElement('button');
			copyBtn.id = 'copy-camera-btn';
			copyBtn.textContent = 'Copy to Clipboard';
			copyBtn.style.margin = '10px 0px';
			copyBtn.style.fontSize = '12px';
			copyBtn.addEventListener('click', function () {
				const cameraPosText = document.getElementById('camera-position').textContent;
				if (cameraPosText) {
					navigator.clipboard.writeText(cameraPosText)
						.then(() => {
							// Change button text temporarily to indicate success
							const originalText = copyBtn.textContent;
							copyBtn.textContent = 'Copied!';
							setTimeout(() => {
								copyBtn.textContent = originalText;
							}, 1500);
						})
						.catch(err => {
							console.error('Could not copy text: ', err);
							copyBtn.textContent = 'Copy failed';
							setTimeout(() => {
								copyBtn.textContent = 'Copy to Clipboard';
							}, 1500);
						});
				}
			});

			// Add elements to GUI
			gui.appendChild(printCameraBtn);
			gui.appendChild(cameraPositionDiv);
			gui.appendChild(copyBtn);
			// make these display none:
			printCameraBtn.style = "display: none;"
			cameraPositionDiv.style = "display: none;"
			copyBtn.style = "display: none;"

		});
	</script>
</body>

</html>